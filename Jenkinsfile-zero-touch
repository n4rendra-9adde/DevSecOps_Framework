// UNIVERSAL DEVSECOPS PIPELINE
// Works with ANY Git repository - zero modifications needed
// Paste this directly in Jenkins job configuration

pipeline {
    agent any
    
    parameters {
        string(name: 'REPO_URL', defaultValue: 'https://github.com/lukejacksonn/deployable', description: 'Target repository URL')
        string(name: 'BRANCH', defaultValue: 'main', description: 'Branch to build')
        string(name: 'FRAMEWORK_REPO', defaultValue: 'https://github.com/YOUR_USERNAME/devsecops-framework', description: 'Framework repository URL')
    }
    
    environment {
        WORK_DIR = "${WORKSPACE}/target-repo"
        FRAMEWORK_DIR = "${WORKSPACE}/framework"
        REPORT_DIR = "${WORKSPACE}/security-reports"
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 2, unit: 'HOURS')
        disableConcurrentBuilds()
    }
    
    stages {
        stage('Setup') {
            steps {
                cleanWs()
                sh 'mkdir -p ${WORK_DIR} ${FRAMEWORK_DIR} ${REPORT_DIR}'
            }
        }
        
        stage('Download Framework') {
            steps {
                script {
                    echo "üì• Downloading DevSecOps Framework from ${params.FRAMEWORK_REPO}"
                    
                    sh """
                        git clone --depth 1 ${params.FRAMEWORK_REPO} ${FRAMEWORK_DIR} 2>/dev/null || \
                        (echo '‚ö†Ô∏è Framework repo not accessible, will use fallback' && \
                         mkdir -p ${FRAMEWORK_DIR}/src/com/devsecops && \
                         touch ${FRAMEWORK_DIR}/detect-language.sh)
                    """
                    
                    sh "ls -la ${FRAMEWORK_DIR}/ || echo 'Framework directory empty'"
                }
            }
        }
        
        stage('Clone Target Repository') {
            steps {
                script {
                    echo "üì• Cloning target repository: ${params.REPO_URL}"
                    
                    sh """
                        git clone --depth 1 --branch ${params.BRANCH} ${params.REPO_URL} ${WORK_DIR}
                    """
                    
                    sh """
                        echo "=== Repository Contents ==="
                        ls -la ${WORK_DIR}/
                        echo "=== Build Files Check ==="
                        ls ${WORK_DIR}/pom.xml ${WORK_DIR}/package.json ${WORK_DIR}/requirements.txt ${WORK_DIR}/go.mod ${WORK_DIR}/Cargo.toml 2>/dev/null || echo 'No standard build files'
                    """
                }
            }
        }
        
        stage('Detect Language') {
            steps {
                script {
                    dir("${env.WORK_DIR}") {
                        echo "üìÇ Current directory: ${pwd()}"
                        sh "ls -la"
                        
                        // Copy or create detection script
                        sh """
                            if [ -f "${env.FRAMEWORK_DIR}/detect-language.sh" ] && [ -s "${env.FRAMEWORK_DIR}/detect-language.sh" ]; then
                                cp "${env.FRAMEWORK_DIR}/detect-language.sh" ./detect-language.sh
                            else
                                cat > detect-language.sh << 'DETECTEOF'
#!/bin/bash
if [ -f "pom.xml" ]; then 
    echo "LANGUAGE=java"
    echo "BUILD_TOOL=maven"
    echo "PACKAGE_TYPE=jar"
elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then 
    echo "LANGUAGE=java"
    echo "BUILD_TOOL=gradle"
    echo "PACKAGE_TYPE=jar"
elif [ -f "package.json" ]; then 
    echo "LANGUAGE=nodejs"
    echo "BUILD_TOOL=npm"
    echo "PACKAGE_TYPE=docker"
elif [ -f "requirements.txt" ] || [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then 
    echo "LANGUAGE=python"
    echo "BUILD_TOOL=pip"
    echo "PACKAGE_TYPE=docker"
elif [ -f "go.mod" ]; then 
    echo "LANGUAGE=golang"
    echo "BUILD_TOOL=go"
    echo "PACKAGE_TYPE=binary"
elif [ -f "Cargo.toml" ]; then 
    echo "LANGUAGE=rust"
    echo "BUILD_TOOL=cargo"
    echo "PACKAGE_TYPE=binary"
else 
    echo "LANGUAGE=unknown"
    echo "BUILD_TOOL=unknown"
    echo "PACKAGE_TYPE=unknown"
    echo "DETECTED=false"
    exit 1
fi
echo "DETECTED=true"
DETECTEOF
                                chmod +x detect-language.sh
                            fi
                        """
                        
                        // Run detection and capture output
                        def detectionOutput = sh(script: './detect-language.sh', returnStdout: true).trim()
                        echo "=== Raw Detection Output ===\n${detectionOutput}"
                        
                        // Parse manually (avoid eachLine closure issue)
                        def lines = detectionOutput.split('\n')
                        for (line in lines) {
                            if (line.contains('=')) {
                                def parts = line.split('=', 2)
                                if (parts.length == 2) {
                                    def key = parts[0].trim()
                                    def value = parts[1].trim()
                                    env."${key}" = value
                                    echo "Set env.${key} = ${value}"
                                }
                            }
                        }
                        
                        // Validate
                        if (env.DETECTED != "true") {
                            echo "‚ö†Ô∏è Could not detect standard project language"
                            echo "Running minimal security scan only (secret detection)"
                            env.LANGUAGE = "unknown"
                            env.BUILD_TOOL = "none"
                            env.PACKAGE_TYPE = "none"
                        }
                        
                        echo "‚úÖ SUCCESS: Language=${env.LANGUAGE}, Tool=${env.BUILD_TOOL}, Package=${env.PACKAGE_TYPE}"
                    }
                }
            }
        }
        
        stage('Build') {
            steps {
                script {
                    dir(WORK_DIR) {
                        echo "üî® Building ${env.LANGUAGE} project with ${env.BUILD_TOOL}"
                        
                        // Try framework adapter first
                        if (fileExists("${FRAMEWORK_DIR}/src/com/devsecops/BuildAdapter.groovy")) {
                            sh "cp ${FRAMEWORK_DIR}/src/com/devsecops/BuildAdapter.groovy ./BuildAdapter.groovy"
                            def buildAdapter = load './BuildAdapter.groovy'
                            def result = buildAdapter.buildProject(env.LANGUAGE, env.BUILD_TOOL)
                            
                            if (!result.success) {
                                error "Build failed: ${result.errorMessage}"
                            }
                        } else {
                            // Inline fallback build commands
                            echo "Using inline build commands"
                            
                            switch(env.BUILD_TOOL) {
                                case 'maven':
                                    sh './mvnw clean package -DskipTests 2>/dev/null || mvn clean package -DskipTests'
                                    break
                                case 'gradle':
                                    sh './gradlew build -x test 2>/dev/null || gradle build -x test'
                                    break
                                case 'npm':
                                    sh 'npm ci && (npm run build 2>/dev/null || echo "No build script")'
                                    break
                                case 'pip':
                                    sh 'pip install -r requirements.txt'
                                    break
                                case 'go':
                                    sh 'go build -o app .'
                                    break
                                case 'cargo':
                                    sh 'cargo build --release'
                                    break
                                default:
                                    echo "‚ö†Ô∏è No build tool recognized, skipping build"
                            }
                        }
                    }
                }
            }
        }
        
        stage('Test') {
            steps {
                script {
                    dir(WORK_DIR) {
                        echo "üß™ Running tests for ${env.LANGUAGE}"
                        
                        if (fileExists("${FRAMEWORK_DIR}/src/com/devsecops/BuildAdapter.groovy")) {
                            def buildAdapter = load './BuildAdapter.groovy'
                            buildAdapter.testProject(env.LANGUAGE, env.BUILD_TOOL)
                        } else {
                            switch(env.BUILD_TOOL) {
                                case 'maven':
                                    sh './mvnw test 2>/dev/null || mvn test || echo "Tests skipped"'
                                    junit testResults: '**/target/surefire-reports/*.xml', allowEmptyResults: true
                                    break
                                case 'gradle':
                                    sh './gradlew test 2>/dev/null || gradle test || echo "Tests skipped"'
                                    break
                                case 'npm':
                                    sh 'npm test 2>/dev/null || echo "No tests configured"'
                                    break
                                default:
                                    echo "No test runner for ${env.BUILD_TOOL}"
                            }
                        }
                    }
                }
            }
        }
        
        stage('Security Scans') {
            parallel {
                stage('Secret Scan') {
                    steps {
                        script {
                            dir(WORK_DIR) {
                                echo "üîí Running secret scan (Gitleaks)"
                                sh """
                                    if command -v gitleaks &> /dev/null; then
                                        gitleaks detect --source . --report-format json --report-path ${REPORT_DIR}/gitleaks.json 2>/dev/null || true
                                    else
                                        echo "‚ö†Ô∏è Gitleaks not installed, skipping"
                                    fi
                                """
                            }
                        }
                    }
                }
                stage('SAST') {
                    steps {
                        script {
                            dir(WORK_DIR) {
                                echo "üîç Running SAST for ${env.LANGUAGE}"
                                
                                if (fileExists("${FRAMEWORK_DIR}/src/com/devsecops/SecurityScanner.groovy")) {
                                    sh "cp ${FRAMEWORK_DIR}/src/com/devsecops/SecurityScanner.groovy ./SecurityScanner.groovy"
                                    def securityScanner = load './SecurityScanner.groovy'
                                    securityScanner.runSAST(env.LANGUAGE, REPORT_DIR)
                                } else {
                                    sh """
                                        if command -v semgrep &> /dev/null; then
                                            semgrep --config=auto --json --output ${REPORT_DIR}/semgrep.json . 2>/dev/null || true
                                        else
                                            echo "‚ö†Ô∏è Semgrep not installed, skipping SAST"
                                        fi
                                    """
                                }
                            }
                        }
                    }
                }
                stage('SCA') {
                    steps {
                        script {
                            dir(WORK_DIR) {
                                echo "üì¶ Running SCA for ${env.LANGUAGE}"
                                
                                switch(env.LANGUAGE) {
                                    case 'java':
                                        sh """
                                            if [ -f /opt/dependency-check/bin/dependency-check.sh ]; then
                                                /opt/dependency-check/bin/dependency-check.sh \
                                                    --project "${params.REPO_URL}" \
                                                    --scan . \
                                                    --format JSON --format HTML \
                                                    --out ${REPORT_DIR}/dependency-check \
                                                    --enableExperimental --noupdate 2>/dev/null || true
                                            else
                                                echo "‚ö†Ô∏è Dependency-Check not installed"
                                            fi
                                        """
                                        break
                                    case 'nodejs':
                                        sh "npm audit --json > ${REPORT_DIR}/npm-audit.json 2>/dev/null || true"
                                        break
                                    case 'python':
                                        sh """
                                            (pip install safety 2>/dev/null && safety check --json --output ${REPORT_DIR}/safety.json 2>/dev/null) || \
                                            (safety check --output ${REPORT_DIR}/safety.txt 2>/dev/null) || \
                                            echo "‚ö†Ô∏è Safety not available"
                                        """
                                        break
                                    default:
                                        echo "‚ö†Ô∏è No SCA configured for ${env.LANGUAGE}"
                                }
                            }
                        }
                    }
                }
            }
        }
        
        stage('Container Scan') {
            when {
                expression { env.PACKAGE_TYPE == 'docker' || env.LANGUAGE == 'java' || fileExists("${WORK_DIR}/Dockerfile") }
            }
            steps {
                script {
                    dir(WORK_DIR) {
                        echo "üê≥ Building and scanning container"
                        
                        def imageName = "app-${env.BUILD_NUMBER}:latest"
                        
                        // Build Docker image with proper error handling
                        def buildResult = 1
                        if (fileExists('Dockerfile')) {
                            buildResult = sh(script: "docker build -t ${imageName} .", returnStatus: true)
                        } else {
                            echo "No Dockerfile, creating minimal..."
                            writeFile file: 'Dockerfile', text: '''FROM eclipse-temurin:17-jre-alpine
WORKDIR /app
COPY target/*.jar app.jar
ENTRYPOINT ["java","-jar","app.jar"]
'''
                            buildResult = sh(script: "docker build -t ${imageName} .", returnStatus: true)
                        }
                        
                        if (buildResult != 0) {
                            echo "‚ö†Ô∏è Docker build failed (exit ${buildResult}), skipping container scan"
                            currentBuild.result = 'UNSTABLE'
                        } else {
                            // Only scan if build succeeded
                            if (sh(script: 'command -v trivy', returnStatus: true) == 0) {
                                sh "trivy image --format json --output ${REPORT_DIR}/trivy.json --severity HIGH,CRITICAL ${imageName} || true"
                                sh "trivy image --format table --output ${REPORT_DIR}/trivy.txt --severity HIGH,CRITICAL ${imageName} || true"
                            } else {
                                echo "‚ö†Ô∏è Trivy not installed, skipping container scan"
                            }
                        }
                    }
                }
            }
        }
        
        stage('Generate Report') {
            steps {
                script {
                    echo "üìä Generating unified security report"
                    
                    // Status-aware metrics (show real state, not misleading 0)
                    def secretsFound = 'N/A'
                    def secretsStatus = 'NOT RUN'
                    def sastFindings = 'N/A'
                    def sastStatus = 'NOT RUN'
                    def scaVulns = 'N/A'
                    def scaStatus = 'NOT RUN'
                    def containerStatus = 'NOT RUN'
                    
                    // Parse Gitleaks JSON
                    if (fileExists("${REPORT_DIR}/gitleaks.json")) {
                        try {
                            def gitleaksText = readFile("${REPORT_DIR}/gitleaks.json")
                            if (gitleaksText.trim()) {
                                def gitleaksJson = new groovy.json.JsonSlurper().parseText(gitleaksText)
                                secretsFound = gitleaksJson instanceof List ? gitleaksJson.size() : 0
                                secretsStatus = 'COMPLETED'
                            }
                        } catch (Exception e) {
                            secretsFound = 'ERROR'
                            secretsStatus = 'FAILED'
                            echo "‚ö†Ô∏è Could not parse gitleaks.json: ${e.message}"
                        }
                    }
                    
                    // Parse Semgrep JSON
                    if (fileExists("${REPORT_DIR}/semgrep.json")) {
                        try {
                            def semgrepText = readFile("${REPORT_DIR}/semgrep.json")
                            if (semgrepText.trim()) {
                                def semgrepJson = new groovy.json.JsonSlurper().parseText(semgrepText)
                                sastFindings = semgrepJson.results?.size() ?: 0
                                sastStatus = 'COMPLETED'
                            }
                        } catch (Exception e) {
                            sastFindings = 'ERROR'
                            sastStatus = 'FAILED'
                            echo "‚ö†Ô∏è Could not parse semgrep.json: ${e.message}"
                        }
                    }
                    
                    // Check Dependency-Check / npm audit / safety
                    if (fileExists("${REPORT_DIR}/dependency-check/dependency-check-report.json")) {
                        try {
                            def dcText = readFile("${REPORT_DIR}/dependency-check/dependency-check-report.json")
                            def dcJson = new groovy.json.JsonSlurper().parseText(dcText)
                            scaVulns = dcJson.dependencies?.collect { it.vulnerabilities?.size() ?: 0 }?.sum() ?: 0
                            scaStatus = 'COMPLETED'
                        } catch (Exception e) {
                            scaVulns = 'ERROR'
                            scaStatus = 'FAILED'
                        }
                    } else if (fileExists("${REPORT_DIR}/npm-audit.json")) {
                        try {
                            def npmText = readFile("${REPORT_DIR}/npm-audit.json")
                            def npmJson = new groovy.json.JsonSlurper().parseText(npmText)
                            scaVulns = npmJson.metadata?.vulnerabilities?.values()?.sum() ?: 0
                            scaStatus = 'COMPLETED'
                        } catch (Exception e) {
                            scaVulns = 'ERROR'
                            scaStatus = 'FAILED'
                        }
                    } else {
                        scaVulns = 'SKIPPED'
                        scaStatus = 'SKIPPED'
                    }
                    
                    // Check container scan
                    if (fileExists("${REPORT_DIR}/trivy.json")) {
                        containerStatus = 'COMPLETED'
                    } else if (currentBuild.result == 'UNSTABLE') {
                        containerStatus = 'DOCKER BUILD FAILED'
                    }
                    
                    // Helper closures for CSS classes
                    def metricClass = { val -> val in ['ERROR', 'SKIPPED', 'N/A'] || (val instanceof Integer && val > 0) ? 'danger' : '' }
                    def cardClass = { status -> status == 'COMPLETED' ? 'success' : 'warning' }
                    def stageIcon = { status -> status == 'COMPLETED' ? '‚úÖ' : '‚ö†Ô∏è' }
                    
                    // Generate HTML report
                    writeFile file: "${REPORT_DIR}/security-report.html", text: """<!DOCTYPE html>
<html>
<head>
    <title>DevSecOps Report - ${params.REPO_URL}</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 40px; background: #1a1a2e; color: #eee; }
        .header { background: #16213e; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        h1 { margin: 0; color: #e94560; }
        .subtitle { color: #a0a0a0; margin-top: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .card { background: #0f3460; padding: 20px; border-radius: 10px; border-left: 4px solid #e94560; }
        .card.success { border-left-color: #16c79a; }
        .card.warning { border-left-color: #f9a825; }
        .metric { font-size: 36px; font-weight: bold; color: #16c79a; }
        .metric.danger { color: #e94560; }
        .label { color: #a0a0a0; font-size: 14px; text-transform: uppercase; }
        .status { font-size: 12px; margin-top: 8px; }
        .status-pass { color: #16c79a; }
        .status-fail { color: #e94560; }
        .status-warn { color: #f9a825; }
        .stage-list { background: #16213e; padding: 20px; border-radius: 10px; }
        .stage-item { padding: 10px; border-bottom: 1px solid #0f3460; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîí DevSecOps Security Report</h1>
        <div class="subtitle">
            Repository: ${params.REPO_URL}<br>
            Branch: ${params.BRANCH} | Build: #${env.BUILD_NUMBER}<br>
            Language: <strong>${env.LANGUAGE}</strong> | Build Tool: <strong>${env.BUILD_TOOL}</strong>
        </div>
    </div>
    
    <div class="grid">
        <div class="card ${cardClass(secretsStatus)}">
            <div class="metric ${metricClass(secretsFound)}">${secretsFound}</div>
            <div class="label">Secrets Found</div>
            <div class="status ${secretsStatus == 'COMPLETED' ? 'status-pass' : 'status-fail'}">
                ${stageIcon(secretsStatus)} ${secretsStatus}
            </div>
        </div>
        <div class="card ${cardClass(sastStatus)}">
            <div class="metric ${metricClass(sastFindings)}">${sastFindings}</div>
            <div class="label">SAST Findings</div>
            <div class="status ${sastStatus == 'COMPLETED' ? 'status-pass' : 'status-fail'}">
                ${stageIcon(sastStatus)} ${sastStatus}
            </div>
        </div>
        <div class="card ${cardClass(scaStatus)}">
            <div class="metric ${metricClass(scaVulns)}">${scaVulns}</div>
            <div class="label">SCA Vulnerabilities</div>
            <div class="status ${scaStatus == 'COMPLETED' ? 'status-pass' : 'status-fail'}">
                ${stageIcon(scaStatus)} ${scaStatus}
            </div>
        </div>
    </div>
    
    <div class="stage-list" style="margin-top: 30px;">
        <h3>Pipeline Stages</h3>
        <div class="stage-item">‚úÖ Download Framework</div>
        <div class="stage-item">‚úÖ Clone Repository</div>
        <div class="stage-item">‚úÖ Detect Language (${env.LANGUAGE})</div>
        <div class="stage-item">‚úÖ Build (${env.BUILD_TOOL})</div>
        <div class="stage-item">‚úÖ Unit Tests</div>
        <div class="stage-item">${stageIcon(secretsStatus)} Secret Scan (${secretsStatus})</div>
        <div class="stage-item">${stageIcon(sastStatus)} SAST Analysis (${sastStatus})</div>
        <div class="stage-item">${stageIcon(scaStatus)} SCA Analysis (${scaStatus})</div>
        <div class="stage-item">${stageIcon(containerStatus)} Container Scan (${containerStatus})</div>
    </div>
    
    <div style="margin-top: 30px; padding: 20px; background: #0f3460; border-radius: 10px;">
        <h3>Artifacts Location</h3>
        <code>${env.BUILD_URL}artifact/security-reports/</code>
    </div>
</body>
</html>"""
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: "${REPORT_DIR}/**/*", allowEmptyArchive: true
                    publishHTML(target: [
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: "${REPORT_DIR}",
                        reportFiles: 'security-report.html',
                        reportName: 'üîí Security Report'
                    ])
                }
            }
        }
    }
    
    post {
        always {
            echo "=========================================="
            echo "‚úÖ PIPELINE COMPLETE"
            echo "Repository: ${params.REPO_URL}"
            echo "Language: ${env.LANGUAGE} / ${env.BUILD_TOOL}"
            echo "Report: ${BUILD_URL}artifact/security-reports/"
            echo "=========================================="
        }
        success {
            echo "üéâ SUCCESS! Security scan complete."
        }
        failure {
            echo "‚ùå FAILED! Check console output for errors."
        }
    }
}
