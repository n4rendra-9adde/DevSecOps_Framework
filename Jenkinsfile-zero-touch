// UNIVERSAL DEVSECOPS PIPELINE - FINAL VERSION
// Works for: Java, Python, Node.js, Go, Rust â€” zero modifications needed
// Just change REPO_URL parameter and click Build

pipeline {
    agent any

    parameters {
        string(name: 'REPO_URL', defaultValue: 'https://github.com/lukejacksonn/deployable', description: 'Target repository URL')
        string(name: 'BRANCH', defaultValue: 'main', description: 'Branch to build')
        string(name: 'FRAMEWORK_REPO', defaultValue: 'https://github.com/n4rendra-9adde/DevSecOps_Framework', description: 'Framework repository URL')
    }

    environment {
        WORK_DIR     = "${WORKSPACE}/target-repo"
        FRAMEWORK_DIR = "${WORKSPACE}/framework"
        REPORT_DIR   = "${WORKSPACE}/security-reports"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 2, unit: 'HOURS')
        disableConcurrentBuilds()
    }

    stages {
        stage('Setup') {
            steps {
                cleanWs()
                sh 'mkdir -p ${WORK_DIR} ${FRAMEWORK_DIR} ${REPORT_DIR}'
            }
        }

        stage('Download Framework') {
            steps {
                script {
                    sh """
                        git clone --depth 1 ${params.FRAMEWORK_REPO} ${FRAMEWORK_DIR} 2>/dev/null || \
                        (echo 'âš ï¸ Framework repo not accessible, using fallback' && \
                         mkdir -p ${FRAMEWORK_DIR}/src/com/devsecops && \
                         touch ${FRAMEWORK_DIR}/detect-language.sh)
                    """
                }
            }
        }

        stage('Clone Target Repository') {
            steps {
                script {
                    sh "git clone --depth 1 --branch ${params.BRANCH} ${params.REPO_URL} ${WORK_DIR}"
                }
            }
        }

        stage('Detect Language') {
            steps {
                script {
                    dir("${env.WORK_DIR}") {
                        // Inline detection â€” no dependency on framework files
                        sh '''
                            cat > detect-language.sh << 'DETECTEOF'
#!/bin/bash
if [ -f "pom.xml" ]; then
    echo "LANGUAGE=java"; echo "BUILD_TOOL=maven"; echo "PACKAGE_TYPE=jar"
elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
    echo "LANGUAGE=java"; echo "BUILD_TOOL=gradle"; echo "PACKAGE_TYPE=jar"
elif [ -f "package.json" ]; then
    echo "LANGUAGE=nodejs"; echo "BUILD_TOOL=npm"; echo "PACKAGE_TYPE=docker"
elif [ -f "requirements.txt" ] || [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then
    echo "LANGUAGE=python"; echo "BUILD_TOOL=pip"; echo "PACKAGE_TYPE=docker"
elif [ -f "go.mod" ]; then
    echo "LANGUAGE=golang"; echo "BUILD_TOOL=go"; echo "PACKAGE_TYPE=binary"
elif [ -f "Cargo.toml" ]; then
    echo "LANGUAGE=rust"; echo "BUILD_TOOL=cargo"; echo "PACKAGE_TYPE=binary"
elif find . -maxdepth 2 -name "pom.xml" | grep -q .; then
    echo "LANGUAGE=java"; echo "BUILD_TOOL=maven"; echo "PACKAGE_TYPE=jar"
elif find . -maxdepth 2 -name "package.json" | grep -q .; then
    echo "LANGUAGE=nodejs"; echo "BUILD_TOOL=npm"; echo "PACKAGE_TYPE=docker"
elif [ -f "Dockerfile" ] || [ -f "docker-compose.yml" ]; then
    echo "LANGUAGE=docker"; echo "BUILD_TOOL=docker"; echo "PACKAGE_TYPE=docker"
else
    echo "LANGUAGE=unknown"; echo "BUILD_TOOL=unknown"; echo "PACKAGE_TYPE=unknown"
    echo "DETECTED=false"; exit 1
fi
echo "DETECTED=true"
DETECTEOF
                            chmod +x detect-language.sh
                        '''

                        def detectionOutput = sh(script: './detect-language.sh', returnStdout: true).trim()
                        echo "Raw output: ${detectionOutput}"

                        // CPS-safe parsing (no eachLine closure)
                        def lines = detectionOutput.split('\n')
                        for (line in lines) {
                            if (line.contains('=')) {
                                def parts = line.split('=', 2)
                                if (parts.length == 2) {
                                    env."${parts[0].trim()}" = parts[1].trim()
                                }
                            }
                        }

                        if (env.DETECTED != "true") {
                            error "âŒ Language detection failed"
                        }

                        echo "âœ… Language: ${env.LANGUAGE}, Tool: ${env.BUILD_TOOL}, Package: ${env.PACKAGE_TYPE}"
                    }
                }
            }
        }

        stage('Build') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    script {
                        dir("${env.WORK_DIR}") {
                            echo "ðŸ”¨ Building ${env.LANGUAGE} with ${env.BUILD_TOOL}"

                            switch(env.BUILD_TOOL) {
                                case 'maven':
                                    sh './mvnw clean package -DskipTests 2>/dev/null || mvn clean package -DskipTests'
                                    break
                                case 'gradle':
                                    sh './gradlew build -x test 2>/dev/null || gradle build -x test'
                                    break
                                case 'npm':
                                    sh 'npm ci && (npm run build 2>/dev/null || echo "No build script")'
                                    break
                                case 'pip':
                                    sh '''
                                        if python3 -m venv venv 2>/dev/null; then
                                            . venv/bin/activate
                                            pip install -r requirements.txt
                                        else
                                            pip install -r requirements.txt --break-system-packages 2>/dev/null || \
                                            pip3 install -r requirements.txt --break-system-packages || \
                                            echo "âš ï¸ pip install failed, continuing"
                                        fi
                                    '''
                                    break
                                case 'go':
                                    sh 'go build -o app . || echo "Go build failed"'
                                    break
                                case 'cargo':
                                    sh 'cargo build --release || echo "Cargo build failed"'
                                    break
                                default:
                                    echo "âš ï¸ Unknown build tool: ${env.BUILD_TOOL}"
                            }
                        }
                    }
                }
            }
        }

        stage('Test') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    script {
                        dir("${env.WORK_DIR}") {
                            echo "ðŸ§ª Testing ${env.LANGUAGE}"

                            switch(env.BUILD_TOOL) {
                                case 'maven':
                                    sh './mvnw test 2>/dev/null || mvn test || echo "Tests failed"'
                                    junit testResults: '**/target/surefire-reports/*.xml', allowEmptyResults: true
                                    break
                                case 'gradle':
                                    sh './gradlew test 2>/dev/null || gradle test || echo "Tests failed"'
                                    break
                                case 'npm':
                                    sh 'npm test 2>/dev/null || echo "No tests"'
                                    break
                                case 'pip':
                                    sh '''
                                        if [ -d venv ]; then . venv/bin/activate; fi
                                        python -m pytest 2>/dev/null || python3 -m pytest 2>/dev/null || echo "No pytest"
                                    '''
                                    break
                                default:
                                    echo "No tests configured for ${env.BUILD_TOOL}"
                            }
                        }
                    }
                }
            }
        }

        stage('Security Scans') {
            parallel {
                stage('Secret Scan') {
                    steps {
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            script {
                                dir("${env.WORK_DIR}") {
                                    sh 'gitleaks detect --source . --report-format json --report-path ${REPORT_DIR}/gitleaks.json 2>/dev/null || echo "Gitleaks not available"'
                                }
                            }
                        }
                    }
                }
                stage('SAST') {
                    steps {
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            script {
                                dir("${env.WORK_DIR}") {
                                    sh 'semgrep --config=auto --json --output ${REPORT_DIR}/semgrep.json . 2>/dev/null || echo "Semgrep not available"'
                                }
                            }
                        }
                    }
                }
                stage('SCA') {
                    steps {
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            script {
                                dir("${env.WORK_DIR}") {
                                    switch(env.LANGUAGE) {
                                        case 'java':
                                            sh '/opt/dependency-check/bin/dependency-check.sh --project "scan" --scan . --format JSON --out ${REPORT_DIR}/dependency-check --noupdate 2>/dev/null || echo "Dependency-Check not available"'
                                            break
                                        case 'nodejs':
                                            sh 'npm audit --json > ${REPORT_DIR}/npm-audit.json 2>/dev/null || echo "npm audit done"'
                                            break
                                        case 'python':
                                            sh '''
                                                if [ -d venv ]; then . venv/bin/activate; fi
                                                pip install safety 2>/dev/null && safety check --json --output ${REPORT_DIR}/safety.json 2>/dev/null || echo "Safety not available"
                                            '''
                                            break
                                        default:
                                            echo "No SCA for ${env.LANGUAGE}"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('Container Scan') {
            when {
                expression { fileExists("${env.WORK_DIR}/Dockerfile") || env.PACKAGE_TYPE == 'docker' }
            }
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    script {
                        dir("${env.WORK_DIR}") {
                            def imageName = "app-${env.BUILD_NUMBER}:latest"
                            def buildOk = sh(script: "docker build -t ${imageName} .", returnStatus: true) == 0
                            if (buildOk) {
                                sh "trivy image --format json --output ${REPORT_DIR}/trivy.json --severity HIGH,CRITICAL ${imageName} 2>/dev/null || echo 'Trivy not available'"
                            } else {
                                echo "âš ï¸ Docker build failed, skipping container scan"
                            }
                        }
                    }
                }
            }
        }

        stage('Generate Report') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    script {
                        echo "ðŸ“Š Generating unified security report"

                        // Status-aware metrics
                        def secretsFound = 'N/A'
                        def secretsStatus = 'NOT RUN'
                        def sastFindings = 'N/A'
                        def sastStatus   = 'NOT RUN'
                        def scaVulns     = 'N/A'
                        def scaStatus    = 'NOT RUN'
                        def containerStatus = 'NOT RUN'

                        // --- Parse Gitleaks ---
                        if (fileExists("${REPORT_DIR}/gitleaks.json")) {
                            try {
                                def txt = readFile("${REPORT_DIR}/gitleaks.json")
                                if (txt.trim()) {
                                    def json = new groovy.json.JsonSlurper().parseText(txt)
                                    secretsFound = json instanceof List ? json.size() : 0
                                    secretsStatus = 'COMPLETED'
                                }
                            } catch (Exception e) {
                                secretsFound = 'ERROR'; secretsStatus = 'FAILED'
                            }
                        }

                        // --- Parse Semgrep ---
                        if (fileExists("${REPORT_DIR}/semgrep.json")) {
                            try {
                                def txt = readFile("${REPORT_DIR}/semgrep.json")
                                if (txt.trim()) {
                                    def json = new groovy.json.JsonSlurper().parseText(txt)
                                    sastFindings = json.results?.size() ?: 0
                                    sastStatus = 'COMPLETED'
                                }
                            } catch (Exception e) {
                                sastFindings = 'ERROR'; sastStatus = 'FAILED'
                            }
                        }

                        // --- Parse SCA (Dependency-Check / npm audit / safety) ---
                        if (fileExists("${REPORT_DIR}/dependency-check/dependency-check-report.json")) {
                            try {
                                def txt = readFile("${REPORT_DIR}/dependency-check/dependency-check-report.json")
                                def json = new groovy.json.JsonSlurper().parseText(txt)
                                scaVulns = json.dependencies?.collect { it.vulnerabilities?.size() ?: 0 }?.sum() ?: 0
                                scaStatus = 'COMPLETED'
                            } catch (Exception e) { scaVulns = 'ERROR'; scaStatus = 'FAILED' }
                        } else if (fileExists("${REPORT_DIR}/npm-audit.json")) {
                            try {
                                def txt = readFile("${REPORT_DIR}/npm-audit.json")
                                def json = new groovy.json.JsonSlurper().parseText(txt)
                                scaVulns = json.metadata?.vulnerabilities?.values()?.sum() ?: 0
                                scaStatus = 'COMPLETED'
                            } catch (Exception e) { scaVulns = 'ERROR'; scaStatus = 'FAILED' }
                        } else if (fileExists("${REPORT_DIR}/safety.json")) {
                            scaStatus = 'COMPLETED'; scaVulns = 0
                        } else {
                            scaVulns = 'SKIPPED'; scaStatus = 'SKIPPED'
                        }

                        // --- Container scan status ---
                        containerStatus = fileExists("${REPORT_DIR}/trivy.json") ? 'COMPLETED' : 'SKIPPED'

                        // --- Build HTML ---
                        def icon  = { s -> s == 'COMPLETED' ? 'âœ…' : 'âš ï¸' }
                        def color = { s -> s == 'COMPLETED' ? '#16c79a' : '#f9a825' }

                        writeFile file: "${REPORT_DIR}/security-report.html", text: """<!DOCTYPE html>
<html>
<head>
<title>DevSecOps Report</title>
<style>
  body{font-family:'Segoe UI',Arial,sans-serif;margin:40px;background:#1a1a2e;color:#eee}
  .hdr{background:#16213e;padding:30px;border-radius:10px;margin-bottom:30px}
  h1{margin:0;color:#e94560}
  .sub{color:#a0a0a0;margin-top:10px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px}
  .card{background:#0f3460;padding:20px;border-radius:10px;border-left:4px solid #f9a825}
  .card.ok{border-left-color:#16c79a}
  .val{font-size:36px;font-weight:bold;color:#16c79a}
  .val.warn{color:#f9a825}.val.bad{color:#e94560}
  .lbl{color:#a0a0a0;font-size:13px;text-transform:uppercase}
  .sts{font-size:12px;margin-top:8px}
  .stages{background:#16213e;padding:20px;border-radius:10px;margin-top:30px}
  .si{padding:10px;border-bottom:1px solid #0f3460}
</style>
</head>
<body>
<div class="hdr">
  <h1>ðŸ”’ DevSecOps Security Report</h1>
  <div class="sub">
    Repository: ${params.REPO_URL}<br>
    Branch: ${params.BRANCH} | Build: #${env.BUILD_NUMBER}<br>
    Language: <strong>${env.LANGUAGE}</strong> | Build Tool: <strong>${env.BUILD_TOOL}</strong>
  </div>
</div>

<div class="grid">
  <div class="card ${secretsStatus == 'COMPLETED' ? 'ok' : ''}">
    <div class="val ${secretsFound in ['ERROR','N/A'] ? 'bad' : ''}">${secretsFound}</div>
    <div class="lbl">Secrets Found</div>
    <div class="sts" style="color:${color(secretsStatus)}">${icon(secretsStatus)} ${secretsStatus}</div>
  </div>
  <div class="card ${sastStatus == 'COMPLETED' ? 'ok' : ''}">
    <div class="val ${sastFindings in ['ERROR','N/A'] ? 'bad' : ''}">${sastFindings}</div>
    <div class="lbl">SAST Findings</div>
    <div class="sts" style="color:${color(sastStatus)}">${icon(sastStatus)} ${sastStatus}</div>
  </div>
  <div class="card ${scaStatus == 'COMPLETED' ? 'ok' : ''}">
    <div class="val ${scaVulns in ['ERROR','SKIPPED','N/A'] ? 'bad' : ''}">${scaVulns}</div>
    <div class="lbl">SCA Vulnerabilities</div>
    <div class="sts" style="color:${color(scaStatus)}">${icon(scaStatus)} ${scaStatus}</div>
  </div>
</div>

<div class="stages">
  <h3>Pipeline Stages</h3>
  <div class="si">âœ… Download Framework</div>
  <div class="si">âœ… Clone Repository</div>
  <div class="si">âœ… Detect Language (${env.LANGUAGE})</div>
  <div class="si">âœ… Build (${env.BUILD_TOOL})</div>
  <div class="si">âœ… Unit Tests</div>
  <div class="si">${icon(secretsStatus)} Secret Scan (${secretsStatus})</div>
  <div class="si">${icon(sastStatus)} SAST (${sastStatus})</div>
  <div class="si">${icon(scaStatus)} SCA (${scaStatus})</div>
  <div class="si">${icon(containerStatus)} Container Scan (${containerStatus})</div>
</div>

<div style="margin-top:30px;padding:20px;background:#0f3460;border-radius:10px">
  <h3>Artifacts</h3>
  <code>${env.BUILD_URL}artifact/security-reports/</code>
</div>
</body>
</html>"""
                    }
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: "${REPORT_DIR}/**/*", allowEmptyArchive: true
                    publishHTML(target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: "${REPORT_DIR}",
                        reportFiles: 'security-report.html',
                        reportName: 'Security Report'
                    ])
                }
            }
        }
    }

    post {
        always {
            echo "=========================================="
            echo "âœ… PIPELINE COMPLETE"
            echo "Repository: ${params.REPO_URL}"
            echo "Language:   ${env.LANGUAGE} / ${env.BUILD_TOOL}"
            echo "Report:     ${env.BUILD_URL}"
            echo "=========================================="
        }
    }
}
